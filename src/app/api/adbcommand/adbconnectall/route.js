import { exec } from 'child_process';
import path from 'path';

export async function POST(req) {
  try {
    // ‡∏£‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å body
    const devices = await req.json();  // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏à‡∏≤‡∏Å body (‡∏£‡∏ß‡∏°‡∏ñ‡∏∂‡∏á ip, mac, hostname)
    
    if (!devices || devices.length === 0) {
      return new Response(
        JSON.stringify({ message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• IP' }),
        { status: 400 }
      );
    }

    const adbPath = path.join(process.cwd(), 'src', 'platform-tools', 'adb'); // ‡∏û‡∏≤‡∏ò‡∏Ç‡∏≠‡∏á adb

    const results = [];

    // ‡∏•‡∏π‡∏õ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ó‡∏∏‡∏Å IP ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö
    for (let device of devices) {
      const { ip } = device;  // ‡∏î‡∏∂‡∏á‡πÅ‡∏Ñ‡πà ip ‡∏à‡∏≤‡∏Å‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå
      console.log(`üåê ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ADB ‡πÑ‡∏õ‡∏ó‡∏µ‡πà ${ip}`);  // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ç‡∏ì‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠

      const result = await new Promise((resolve) => {
        exec(`${adbPath} connect ${ip}`, (error, stdout, stderr) => {
          let status = 'connected'; // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏î‡∏µ‡∏ü‡∏≠‡∏•‡∏ï‡πå‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
          let message = `‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ADB ‡∏Å‡∏±‡∏ö ${ip} ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
          let meaagefromadb = `adb message: ${stdout}`;

          // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ stdout ‡∏°‡∏µ‡∏Ñ‡∏≥‡∏ß‡πà‡∏≤ "cannot connect to" ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
          if (stdout.includes('cannot connect to')) {
            status = "can't connect";
            message = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ADB ‡∏Å‡∏±‡∏ö ${ip} ‡πÑ‡∏î‡πâ`;
            meaagefromadb = `adb message: ${stdout}`;
          }
          if (stdout.includes('failed to authenticate')) {
            status = "can't connect";
            message = `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ADB ‡∏Å‡∏±‡∏ö ${ip} ‡πÑ‡∏î‡πâ`;
            meaagefromadb = `adb message: ${stdout}`;
          }

          console.log(message);
          resolve({ ip, status, message, meaagefromadb });
        });
      });

      results.push(result);
    }

    // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
    return new Response(
      JSON.stringify({
        message: '‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ADB ‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô',
        results: results,  // ‡∏™‡πà‡∏á‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ
      }),
      {
        status: 200,
        headers: {
          'Content-Type': 'application/json',
        },
      }
    );
  } catch (error) {
    console.error('‚ùå Error:', error);
    return new Response(
      JSON.stringify({
        status: 'error',
        message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ ADB',
        error: error.message,
      }),
      { status: 500 }
    );
  }
}
